# 软件架构设计文档

## 系统概述

DaShan桌宠机器人采用"表演层+大脑层"的双架构设计，实现低延迟、高交互性的桌面宠物机器人。

## 架构图

```
┌─────────────────────────────────────────────────────────┐
│                        用户                               │
└────────────────────┬────────────────────────────────────┘
                     │ 语音/视觉交互
┌────────────────────▼────────────────────────────────────┐
│                   机器人端 (ESP32-S3)                      │
│  ┌─────────────────────────────────────────────────────┐  │
│  │  应用层 (Application Layer)                        │  │
│  │  - 状态机 (State Machine)                          │  │
│  │  - 动画引擎 (Animation Engine)                     │  │
│  │  - 协议解析 (Protocol Parser)                      │  │
│  └────────────────┬────────────────────────────────────┘  │
│                   │                                        │
│  ┌────────────────▼────────────────────────────────────┐  │
│  │  组件层 (Component Layer)                           │  │
│  │  - LED矩阵控制器 (LED Matrix Controller)           │  │
│  │  - 舵机控制器 (Servo Controller)                    │  │
│  │  - 摄像头驱动 (Camera Driver)                       │  │
│  │  - 音频驱动 (Audio Driver)                          │  │
│  │  - 传感器驱动 (Sensor Driver)                       │  │
│  └────────────────┬────────────────────────────────────┘  │
│                   │                                        │
│  ┌────────────────▼────────────────────────────────────┐  │
│  │  驱动层 (Driver Layer)                             │  │
│  │  - GPIO / PWM / I2C / I2S / SPI                     │  │
│  │  - UART通信                                         │  │
│  └─────────────────────────────────────────────────────┘  │
└────────────────────┬────────────────────────────────────┘
                     │ UART/USB (115200 baud)
┌────────────────────▼────────────────────────────────────┐
│                   主机端 (Python)                        │
│  ┌─────────────────────────────────────────────────────┐  │
│  │  应用层 (Application Layer)                         │  │
│  │  - 主控制器 (Main Controller)                       │  │
│  │  - 行为编排器 (Behavior Orchestrator)               │  │
│  │  - 交互管理器 (Interaction Manager)                 │  │
│  └────────────────┬────────────────────────────────────┘  │
│                   │                                        │
│  ┌────────────────▼────────────────────────────────────┐  │
│  │  功能模块层 (Module Layer)                           │  │
│  │  ┌────────────┐ ┌────────────┐ ┌────────────┐      │  │
│  │  │ 语音模块   │ │ 视觉模块   │ │ 对话模块   │      │  │
│  │  │ - WakeWord │ │ - FaceTrack│ │ - LLM      │      │  │
│  │  │ - STT      │ │ - Camera   │ │ - Memory   │      │  │
│  │  │ - TTS      │ │ - Distance │ │ - Prompt   │      │  │
│  │  └────────────┘ └────────────┘ └────────────┘      │  │
│  │                                                      │  │
│  │  ┌────────────┐ ┌────────────┐                      │  │
│  │  │ 行为模块   │ │ 通信模块   │                      │  │
│  │  │ - Animation│ │ - Serial   │                      │  │
│  │  │ - Emotion  │ │ - Protocol │                      │  │
│  │  └────────────┘ └────────────┘                      │  │
│  └────────────────┬────────────────────────────────────┘  │
│                   │                                        │
│  ┌────────────────▼────────────────────────────────────┐  │
│  │  基础层 (Base Layer)                                │  │
│  │  - 配置管理 (Config)                                │  │
│  │  - 日志系统 (Logger)                                │  │
│  │  - 工具函数 (Utils)                                 │  │
│  └─────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────┘
```

## 机器人端架构

### 状态机设计

```
                    ┌─────────────┐
                    │   SLEEP     │
                    │  休眠状态   │
                    └──────┬──────┘
                           │ 唤醒词检测
                           ▼
                    ┌─────────────┐
                    │   WAKE      │
                    │   唤醒状态   │
                    └──────┬──────┘
                           │
                           ▼
                    ┌─────────────┐
                    │   LISTEN    │
                    │   倾听状态   │
                    └──────┬──────┘
                           │ 录音完成
                           ▼
                    ┌─────────────┐
                    │   THINK     │
                    │   思考状态   │
                    └──────┬──────┘
                           │ 回复生成
                           ▼
                    ┌─────────────┐
                    │   TALK      │
                    │   说话状态   │
                    └──────┬──────┘
                           │
                           │ 30s无交互
                           └─────┐
                                 ▼
                          ┌─────────────┐
                          │   SLEEP     │
                          └─────────────┘
```

### 状态定义

| 状态 | 眼睛表情 | 头部动作 | 持续时间 | 说明 |
|------|----------|----------|----------|------|
| SLEEP | 半闭，呼吸灯 | 静止或微动 | 持续 | 低功耗，仅监听唤醒词 |
| WAKE | 亮起，睁大 | 抬头，看向前方 | 1-2s | 唤醒确认 |
| LISTEN | 注视，稳定 | 微前倾 | 持续 | 表达"在认真听" |
| THINK | 歪头，瞳孔移动 | 左右微摆 | 1-3s | 表达"思考中" |
| TALK | 眨眼，瞳孔高光 | 配合语气点头 | 语音时长 | 配合说话节奏 |

### 组件设计

#### LED矩阵控制器

```c
typedef struct {
    uint8_t matrix[8][8][3];  // RGB数据
    uint8_t brightness;        // 亮度 (0-255)
    uint8_t animation_mode;    // 动画模式
    uint32_t last_update;      // 上次更新时间
} led_matrix_t;
```

**功能**:
- 显示15+预设表情
- 平滑动画过渡
- 呼吸灯效果
- 瞳孔追踪

#### 舵机控制器

```c
typedef struct {
    uint8_t pin;
    uint16_t current_angle;
    uint16_t target_angle;
    uint16_t speed;
    uint32_t last_move_time;
} servo_t;
```

**功能**:
- 平滑运动控制
- 加减速曲线
- 双自由度控制
- 限位保护

#### 摄像头驱动

```c
typedef struct {
    camera_fb_t *fb;
    bool enabled;
    uint16_t width;
    uint16_t height;
} camera_driver_t;
```

**功能**:
- 图像采集
- JPEG压缩
- 传输到主机
- 低功耗控制

#### 音频驱动

```c
typedef struct {
    i2s_port_t mic_port;
    i2s_port_t speaker_port;
    bool recording;
    bool playing;
} audio_driver_t;
```

**功能**:
- I2S麦克风录音
- I2S扬声器播放
- 音量控制
- 回声消除

### 通信协议

#### 帧格式

```
┌──────┬──────┬──────┬──────┬──────┐
| HEAD | CMD  | LEN  | DATA | CRC  |
└──────┴──────┴──────┴──────┴──────┘
 1字节  1字节  2字节  N字节  1字节
```

#### 命令定义

| CMD | 名称 | 方向 | 说明 |
|-----|------|------|------|
| 0x01 | HEARTBEAT | 双向 | 心跳检测 |
| 0x02 | SET_EXPRESSION | 主→机 | 设置表情 |
| 0x03 | SET_SERVO | 主→机 | 控制舵机 |
| 0x04 | PLAY_AUDIO | 主→机 | 播放音频 |
| 0x05 | RECORD_AUDIO | 机→主 | 录音数据 |
| 0x06 | SEND_IMAGE | 机→主 | 发送图像 |
| 0x07 | SET_STATE | 主→机 | 切换状态 |
| 0x08 | GET_STATUS | 主→机 | 获取状态 |
| 0x09 | SENSOR_DATA | 机→主 | 传感器数据 |

---

## 主机端架构

### 模块划分

#### 1. 语音模块

**WakeWord模块**
- 使用openWakeWord进行唤醒词检测
- 支持自定义唤醒词
- 低延迟响应 (<200ms)
- 连续监听，低功耗

**STT模块**
- 使用Whisper进行语音识别
- 支持中英文
- 实时转录
- 降噪处理

**TTS模块**
- 使用Piper进行语音合成
- 自然语音
- 情感语气
- 实时流式输出

#### 2. 视觉模块

**FaceTracker模块**
- 使用OpenCV/face_recognition
- 实时人脸检测
- 注视点计算
- 距离估算

**Camera模块**
- 摄像头管理
- 帧率控制
- 图像预处理
- 缓存管理

#### 3. 对话模块

**LLM模块**
- 集成GLM-4.7 API
- 支持流式输出
- 上下文管理
- 提示词工程

**Memory模块**
- 长期记忆存储
- 对话历史
- 用户偏好
- 学习更新

**Prompt模块**
- 系统提示词
- 情境提示
- 个性化提示
- 提示词模板

#### 4. 行为模块

**Animation模块**
- 动画序列生成
- 平滑过渡
- 节奏同步
- 随机微动

**Emotion模块**
- 情绪识别
- 情绪到表情映射
- 情绪传播
- 情绪衰减

#### 5. 通信模块

**Serial模块**
- UART通信管理
- 协议封装
- 数据缓存
- 错误重传

### 主控制器流程

```python
class MainController:
    def __init__(self):
        self.voice_module = VoiceModule()
        self.vision_module = VisionModule()
        self.dialogue_module = DialogueModule()
        self.behavior_module = BehaviorModule()
        self.protocol = SerialProtocol()
        
    def run(self):
        while True:
            # 1. 检测唤醒词
            if self.voice_module.wake_word_detected():
                self.transition_to('WAKE')
                
                # 2. 开始倾听
                self.transition_to('LISTEN')
                text = self.voice_module.listen()
                
                # 3. 生成回复
                self.transition_to('THINK')
                response = self.dialogue_module.generate(text)
                
                # 4. 播放回复
                self.transition_to('TALK')
                self.voice_module.speak(response)
                
                # 5. 超时返回休眠
                self.wait_idle(30)
                self.transition_to('SLEEP')
```

### 数据流设计

#### 语音交互流程

```
用户语音
  ↓
INMP441 (ESP32)
  ↓ I2S
ESP32录音
  ↓ UART
主机接收
  ↓ openWakeWord
唤醒词检测
  ↓ (检测到)
主机发送"LISTEN"命令
  ↓ UART
ESP32开始录音
  ↓ UART
主机接收音频
  ↓ Whisper
语音转文字
  ↓ GLM-4.7
生成回复
  ↓ Piper
文字转语音
  ↓ UART
ESP32播放音频
  ↓ 表情动画同步
用户听到回复
```

#### 视觉交互流程

```
摄像头捕获
  ↓ OV2640
ESP32采集图像
  ↓ UART
主机接收图像
  ↓ OpenCV
人脸检测
  ↓ face_recognition
人脸识别
  ↓ 计算
注视点坐标
  ↓ UART
ESP32控制舵机
  ↓ 舵机转动
头部转向用户
```

---

## 性能优化

### 机器人端优化

1. **任务调度**: FreeRTOS多任务
   - 优先级: 通信 > 状态机 > 动画 > 传感器
   
2. **内存管理**
   - 使用PSRAM (如可用)
   - 动态内存池
   - 避免内存碎片

3. **功耗优化**
   - 低功耗模式 (Light Sleep)
   - 按需启用外设
   - WiFi仅在传输时开启

4. **实时性保证**
   - 中断优先级
   - DMA传输
   - 避免阻塞调用

### 主机端优化

1. **异步处理**: asyncio协程
   - 并发语音和视觉处理
   - 非阻塞I/O

2. **缓存策略**
   - 模型预加载
   - 对话历史缓存
   - 表情动画缓存

3. **资源管理**
   - 线程池
   - 连接池
   - 内存限制

4. **延迟优化**
   - 预热模型
   - 流式处理
   - 边缘缓存

---

## 扩展性设计

### 硬件扩展

1. **传感器扩展**: 预留GPIO/I2C接口
2. **执行器扩展**: 支持更多舵机
3. **显示扩展**: 支持LCD屏幕
4. **通信扩展**: WiFi/BLE/LoRa

### 软件扩展

1. **插件系统**: 支持自定义模块
2. **配置驱动**: 行为可配置
3. **模型替换**: 支持多种LLM
4. **协议扩展**: 支持更多通信方式

---

## 安全性设计

### 数据安全

1. **加密传输**: UART通信加密
2. **隐私保护**: 本地处理优先
3. **数据脱敏**: 敏感信息过滤

### 访问控制

1. **认证机制**: 唤醒词认证
2. **权限管理**: 功能权限控制
3. **审计日志**: 操作日志记录

---

## 测试策略

### 单元测试

- 每个模块独立测试
- Mock外部依赖
- 覆盖率 >80%

### 集成测试

- 端到端流程测试
- 性能基准测试
- 稳定性测试

### 用户测试

- 真实场景测试
- 用户体验评估
- Bug收集和修复

---

## 文档结构

```
docs/
├── ARCHITECTURE.md     # 本文档
├── HARDWARE.md         # 硬件清单
├── INSTALLATION.md     # 安装指南
├── API.md             # API文档
├── PROTOCOL.md        # 通信协议详解
└── DEVELOPMENT.md     # 开发指南
```

---

## 版本历史

- v1.0.0 (2026-02-02): 初始架构设计

---

**DaShan** - 你的桌面智能伙伴 🤖
