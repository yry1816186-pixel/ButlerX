<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è§†è§‰ç›‘æ§ - æ™ºèƒ½ç®¡å®¶</title>
  <link rel="stylesheet" href="assets/style.css">
  <style>
    :root {
      --primary-color: #0088cc;
      --primary-light: #e6f4fa;
      --success-color: #10b981;
      --warning-color: #f59e0b;
      --danger-color: #ef4444;
      --info-color: #3b82f6;
      --bg-primary: #f5f7fa;
      --bg-secondary: #ffffff;
      --bg-tertiary: #e8ecf1;
      --text-primary: #1a1a2e;
      --text-secondary: #64748b;
      --border-color: #e2e8f0;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.08);
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 16px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
    }

    .layout {
      display: flex;
      min-height: 100vh;
    }

    .sidebar {
      width: 260px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border-color);
      position: fixed;
      height: 100vh;
      left: 0;
      top: 0;
      z-index: 100;
    }

    .sidebar-header {
      padding: 24px 20px;
      border-bottom: 1px solid var(--border-color);
    }

    .sidebar-header h1 {
      font-size: 20px;
      font-weight: 700;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sidebar-header h1::before {
      content: 'ğŸ ';
      font-size: 24px;
    }

    .nav-section {
      padding: 16px 12px;
    }

    .nav-section-title {
      font-size: 11px;
      font-weight: 600;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 8px 12px;
      margin-bottom: 4px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      margin: 4px 0;
      border-radius: 8px;
      color: var(--text-secondary);
      text-decoration: none;
      transition: all 0.2s;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
    }

    .nav-item:hover {
      background: var(--primary-light);
      color: var(--primary-color);
    }

    .nav-item.active {
      background: var(--primary-light);
      color: var(--primary-color);
      font-weight: 600;
    }

    .nav-item::before {
      content: attr(data-icon);
      font-size: 18px;
      margin-right: 12px;
      width: 24px;
      text-align: center;
    }

    .main-content {
      flex: 1;
      margin-left: 260px;
      min-height: 100vh;
    }

    .top-bar {
      height: 64px;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 32px;
      position: sticky;
      top: 0;
      z-index: 90;
    }

    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      color: var(--text-secondary);
    }

    .breadcrumb a {
      color: var(--text-secondary);
      text-decoration: none;
    }

    .breadcrumb a:hover {
      color: var(--primary-color);
    }

    .breadcrumb .current {
      color: var(--primary-color);
      font-weight: 600;
    }

    .top-bar-right {
      display: flex;
      align-items: center;
      gap: 24px;
    }

    .notification-btn {
      position: relative;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 20px;
      color: var(--text-secondary);
    }

    .notification-btn:hover {
      color: var(--primary-color);
    }

    .notification-badge {
      position: absolute;
      top: -4px;
      right: -4px;
      background: var(--danger-color);
      color: white;
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 10px;
      font-weight: 600;
    }

    .user-profile {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 12px;
      border-radius: 20px;
      background: var(--bg-primary);
      cursor: pointer;
    }

    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--primary-color);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 600;
    }

    .user-name {
      font-size: 14px;
      font-weight: 500;
    }

    .page-content {
      padding: 32px;
    }

    .page-header {
      margin-bottom: 24px;
    }

    .page-title {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 8px;
    }

    .page-subtitle {
      font-size: 14px;
      color: var(--text-secondary);
    }

    .main-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 24px;
    }

    .camera-section {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .section-title {
      font-size: 16px;
      font-weight: 600;
    }

    .camera-controls {
      display: flex;
      gap: 8px;
    }

    .btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      border: none;
      transition: all 0.2s;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .btn-primary:hover {
      background: #0077b3;
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-color);
      color: var(--text-primary);
    }

    .btn-secondary:hover {
      border-color: var(--primary-color);
      color: var(--primary-color);
    }

    .btn-danger {
      background: #fee2e2;
      color: var(--danger-color);
    }

    .btn-danger:hover {
      background: #fecaca;
    }

    .video-container {
      position: relative;
      background: #000;
      border-radius: 8px;
      overflow: hidden;
    }

    #video {
      width: 100%;
      display: block;
    }

    #canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    .detection-sidebar {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .detection-panel {
      background: var(--bg-secondary);
      border-radius: 12px;
      padding: 20px;
      border: 1px solid var(--border-color);
      box-shadow: var(--shadow-sm);
    }

    .panel-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      border-bottom: 1px solid var(--border-color);
      padding-bottom: 0;
    }

    .panel-tab {
      padding: 10px 16px;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-secondary);
      cursor: pointer;
    }

    .panel-tab:hover {
      color: var(--primary-color);
    }

    .panel-tab.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
      font-weight: 600;
    }

    .detection-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-height: 400px;
      overflow-y: auto;
    }

    .detection-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 12px;
      background: var(--bg-primary);
      border-radius: 8px;
      border-left: 3px solid var(--info-color);
    }

    .detection-item.object {
      border-left-color: var(--info-color);
    }

    .detection-item.person {
      border-left-color: var(--primary-color);
    }

    .detection-item.face {
      border-left-color: var(--success-color);
    }

    .detection-icon {
      font-size: 28px;
      flex-shrink: 0;
    }

    .detection-info {
      flex: 1;
      min-width: 0;
    }

    .detection-name {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
      word-break: break-word;
    }

    .detection-details {
      font-size: 12px;
      color: var(--text-secondary);
      line-height: 1.4;
    }

    .detection-confidence {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 600;
      margin-top: 4px;
    }

    .detection-confidence.high {
      background: #d1fae5;
      color: var(--success-color);
    }

    .detection-confidence.medium {
      background: #fef3c7;
      color: var(--warning-color);
    }

    .detection-confidence.low {
      background: #fee2e2;
      color: var(--danger-color);
    }

    .face-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 12px;
    }

    .face-card {
      text-align: center;
    }

    .face-image {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      background: var(--bg-tertiary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      margin-bottom: 8px;
      border: 3px solid var(--border-color);
      overflow: hidden;
    }

    .face-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .face-name {
      font-size: 12px;
      font-weight: 600;
      word-break: break-word;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 600;
    }

    .status-badge.active {
      background: #d1fae5;
      color: var(--success-color);
    }

    .status-badge.inactive {
      background: #fee2e2;
      color: var(--danger-color);
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.7);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      color: white;
    }

    .spinner {
      width: 48px;
      height: 48px;
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .loading-text {
      margin-top: 16px;
      font-size: 14px;
    }

    @media (max-width: 1024px) {
      .main-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .sidebar {
        display: none;
      }
      .main-content {
        margin-left: 0;
      }
      .top-bar {
        padding: 0 16px;
      }
      .page-content {
        padding: 20px 16px;
      }
    }
  </style>
</head>
<body>
  <div class="layout">
    <aside class="sidebar">
      <div class="sidebar-header">
        <h1>æ™ºèƒ½ç®¡å®¶</h1>
      </div>
      <nav>
        <div class="nav-section">
          <div class="nav-section-title">ä¸»èœå•</div>
          <a href="dashboard.html" class="nav-item" data-icon="ğŸ“Š">ä»ªè¡¨ç›˜</a>
          <a href="devices.html" class="nav-item" data-icon="ğŸ”Œ">è®¾å¤‡ç®¡ç†</a>
          <a href="scenes.html" class="nav-item" data-icon="ğŸ¬">åœºæ™¯æ§åˆ¶</a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">åŠŸèƒ½</div>
          <a href="ai.html" class="nav-item" data-icon="ğŸ¤–">AI åŠ©æ‰‹</a>
          <a href="vision.html" class="nav-item active" data-icon="ğŸ‘ï¸">è§†è§‰ç›‘æ§</a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">ç›‘æ§</div>
          <a href="health.html" class="nav-item" data-icon="ğŸ’“">ç³»ç»Ÿå¥åº·</a>
          <a href="alerts.html" class="nav-item" data-icon="ğŸ””">å‘Šè­¦ä¸­å¿ƒ</a>
          <a href="logs.html" class="nav-item" data-icon="ğŸ“‹">æ—¥å¿—è®°å½•</a>
        </div>
        <div class="nav-section">
          <div class="nav-section-title">ç³»ç»Ÿ</div>
          <a href="security.html" class="nav-item" data-icon="ğŸ”">ç”¨æˆ·ç®¡ç†</a>
          <a href="settings.html" class="nav-item" data-icon="âš™ï¸">ç³»ç»Ÿè®¾ç½®</a>
        </div>
      </nav>
    </aside>

    <main class="main-content">
      <header class="top-bar">
        <div class="breadcrumb">
          <a href="dashboard.html">é¦–é¡µ</a>
          <span>/</span>
          <span class="current">è§†è§‰ç›‘æ§</span>
        </div>
        <div class="top-bar-right">
          <button class="notification-btn">
            ğŸ””
            <span class="notification-badge" id="alertCount">0</span>
          </button>
          <div class="user-profile">
            <div class="user-avatar">A</div>
            <span class="user-name">ç®¡ç†å‘˜</span>
          </div>
        </div>
      </header>

      <div class="page-content">
        <div class="page-header">
          <h1 class="page-title">è§†è§‰ç›‘æ§</h1>
          <p class="page-subtitle">å®æ—¶æ™ºèƒ½ç‰©ä½“æ£€æµ‹å’Œäººè„¸è¯†åˆ«</p>
        </div>

        <div class="main-grid">
          <div class="camera-section">
            <div class="section-header">
              <div class="section-title">å®æ—¶ç›‘æ§</div>
              <div class="camera-controls">
                <button class="btn btn-primary" id="startBtn" onclick="startCamera()">å¯åŠ¨æ‘„åƒå¤´</button>
                <button class="btn btn-secondary" id="stopBtn" onclick="stopCamera()" disabled>åœæ­¢</button>
              </div>
            </div>
            <div class="video-container">
              <video id="video" autoplay muted playsinline></video>
              <canvas id="canvas"></canvas>
            </div>
          </div>

          <div class="detection-sidebar">
            <div class="detection-panel">
              <div class="panel-tabs">
                <button class="panel-tab active" data-tab="objects" onclick="switchTab('objects')">ç‰©ä½“</button>
                <button class="panel-tab" data-tab="faces" onclick="switchTab('faces')">äººè„¸</button>
              </div>
              
              <div id="objectsTab" class="tab-content">
                <div class="detection-list" id="objectList">
                  <div class="empty-state">
                    <div class="empty-state-icon">ğŸ“·</div>
                    <div>å¯åŠ¨æ‘„åƒå¤´åå¼€å§‹æ£€æµ‹</div>
                  </div>
                </div>
              </div>
              
              <div id="facesTab" class="tab-content" style="display: none;">
                <div class="detection-list" id="faceList">
                  <div class="empty-state">
                    <div class="empty-state-icon">ğŸ‘¤</div>
                    <div>æš‚æ— å·²çŸ¥äººè„¸</div>
                  </div>
                </div>
              </div>
            </div>

            <div class="detection-panel">
              <div class="section-header">
                <div class="section-title">äººè„¸åº“</div>
                <button class="btn btn-secondary" style="padding: 4px 10px; font-size: 11px;" onclick="clearFaceLibrary()">æ¸…ç©º</button>
              </div>
              <div class="face-grid" id="faceLibrary">
                <div class="empty-state" style="grid-column: 1 / -1; padding: 20px;">
                  <div class="empty-state-icon">ğŸ‘¥</div>
                  <div>æ·»åŠ äººè„¸åˆ°è¯†åˆ«åº“</div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <div class="loading-overlay" id="loadingOverlay">
    <div class="spinner"></div>
    <div class="loading-text" id="loadingText">æ­£åœ¨åŠ è½½AIæ¨¡å‹...</div>
  </div>

  <script>
    const cocoLabels = {
      1: 'äºº', 2: 'è‡ªè¡Œè½¦', 3: 'æ±½è½¦', 4: 'æ‘©æ‰˜è½¦', 5: 'é£æœº',
      6: 'å…¬äº¤è½¦', 7: 'ç«è½¦', 8: 'å¡è½¦', 9: 'èˆ¹', 10: 'äº¤é€šç¯',
      11: 'æ¶ˆé˜²æ “', 12: 'åœè½¦æ ‡å¿—', 13: 'åœè½¦è¡¨', 14: 'é•¿æ¤…', 15: 'é¸Ÿ',
      16: 'çŒ«', 17: 'ç‹—', 18: 'é©¬', 19: 'ç¾Š', 20: 'ç‰›',
      21: 'å¤§è±¡', 22: 'ç†Š', 23: 'æ–‘é©¬', 24: 'é•¿é¢ˆé¹¿', 25: 'èƒŒåŒ…',
      26: 'é›¨ä¼', 27: 'æ‰‹æåŒ…', 28: 'é¢†å¸¦', 29: 'æ‰‹æç®±', 30: 'é£ç›˜',
      31: 'æ»‘é›ªæ¿', 32: 'è¿åŠ¨çƒ', 33: 'é£ç­', 34: 'æ£’çƒæ£’', 35: 'æ£’çƒæ‰‹å¥—',
      36: 'æ»‘æ¿', 37: 'å†²æµªæ¿', 38: 'ç½‘çƒæ‹', 39: 'ç“¶å­', 40: 'é…’æ¯',
      41: 'æ¯å­', 42: 'å‰å­', 43: 'åˆ€', 44: 'å‹ºå­', 45: 'ç¢—',
      46: 'é¦™è•‰', 47: 'è‹¹æœ', 48: 'ä¸‰æ˜æ²»', 49: 'æ©™å­', 50: 'è¥¿å…°èŠ±',
      51: 'èƒ¡èåœ', 52: 'çƒ­ç‹—', 53: 'æŠ«è¨', 54: 'ç”œç”œåœˆ', 55: 'è›‹ç³•',
      56: 'æ¤…å­', 57: 'æ²™å‘', 58: 'ç›†æ ½', 59: 'åºŠ', 60: 'é¤æ¡Œ',
      61: 'é©¬æ¡¶', 62: 'ç”µè§†', 63: 'ç¬”è®°æœ¬ç”µè„‘', 64: 'é¼ æ ‡', 65: 'é¥æ§å™¨',
      66: 'é”®ç›˜', 67: 'æ‰‹æœº', 68: 'å¾®æ³¢ç‚‰', 69: 'çƒ¤ç®±', 70: 'çƒ¤é¢åŒ…æœº',
      71: 'æ´—ç¢—æœº', 72: 'æ°´æ§½', 73: 'å†°ç®±', 74: 'ä¹¦', 75: 'é—¹é’Ÿ',
      76: 'èŠ±ç“¶', 77: 'å‰ªåˆ€', 78: 'æ³°è¿ªç†Š', 79: 'å¹é£æœº', 80: 'ç‰™åˆ·'
    };

    const objectIcons = {
      'äºº': 'ğŸ‘¤', 'è‡ªè¡Œè½¦': 'ğŸš²', 'æ±½è½¦': 'ğŸš—', 'æ‘©æ‰˜è½¦': 'ğŸï¸', 'é£æœº': 'âœˆï¸',
      'å…¬äº¤è½¦': 'ğŸšŒ', 'ç«è½¦': 'ğŸš‚', 'å¡è½¦': 'ğŸš›', 'èˆ¹': 'ğŸš¤', 'çŒ«': 'ğŸ±',
      'ç‹—': 'ğŸ•', 'é¸Ÿ': 'ğŸ¦', 'æ‰‹æœº': 'ğŸ“±', 'ç¬”è®°æœ¬ç”µè„‘': 'ğŸ’»', 'ç“¶å­': 'ğŸ¼',
      'æ¯å­': 'â˜•', 'æ¤…å­': 'ğŸª‘', 'æ²™å‘': 'ğŸ›‹ï¸', 'ç”µè§†': 'ğŸ“º'
    };

    let model = null;
    let faceDetectionNet = null;
    let faceRecognitionNet = null;
    let faceDescriptor = null;
    let stream = null;
    let isRunning = false;
    let detectionInterval = null;
    let currentTab = 'objects';
    
    let faceLibrary = JSON.parse(localStorage.getItem('faceLibrary') || '[]');
    let recentDetections = [];
    let detectedFaces = new Map();

    async function loadModels() {
      try {
        document.getElementById('loadingText').textContent = 'æ­£åœ¨åŠ è½½ç‰©ä½“æ£€æµ‹æ¨¡å‹...';
        
        const script = document.createElement('script');
        script.src = 'https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.2.0/dist/tf.min.js';
        document.head.appendChild(script);
        
        await new Promise(resolve => script.onload = resolve);
        
        const cocoScript = document.createElement('script');
        cocoScript.src = 'https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.2/dist/coco-ssd.min.js';
        document.head.appendChild(cocoScript);
        
        await new Promise(resolve => cocoScript.onload = resolve);
        
        document.getElementById('loadingText').textContent = 'æ­£åœ¨åŠ è½½äººè„¸è¯†åˆ«æ¨¡å‹...';
        
        const faceApiScript = document.createElement('script');
        faceApiScript.src = 'https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js';
        document.head.appendChild(faceApiScript);
        
        await new Promise(resolve => faceApiScript.onload = resolve);
        
        await Promise.all([
          faceapi.nets.tinyFaceDetector.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api-model@1.0.0/'),
          faceapi.nets.faceLandmark68Net.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api-model@1.0.0/'),
          faceapi.nets.faceRecognitionNet.loadFromUri('https://cdn.jsdelivr.net/npm/@vladmandic/face-api-model@1.0.0/')
        ]);
        
        document.getElementById('loadingText').textContent = 'åˆå§‹åŒ–å®Œæˆ';
        
        setTimeout(() => {
          document.getElementById('loadingOverlay').style.display = 'none';
        }, 500);
        
        renderFaceLibrary();
      } catch (error) {
        console.error('æ¨¡å‹åŠ è½½å¤±è´¥:', error);
        document.getElementById('loadingText').textContent = 'æ¨¡å‹åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•';
      }
    }

    async function startCamera() {
      try {
        stream = await navigator.mediaDevices.getUserMedia({
          video: { width: 640, height: 480, facingMode: 'environment' }
        });
        
        const video = document.getElementById('video');
        video.srcObject = stream;
        
        await new Promise(resolve => video.onloadedmetadata = resolve);
        
        const canvas = document.getElementById('canvas');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        
        document.getElementById('startBtn').disabled = true;
        document.getElementById('stopBtn').disabled = false;
        
        isRunning = true;
        detectFrame();
        
      } catch (error) {
        console.error('æ‘„åƒå¤´å¯åŠ¨å¤±è´¥:', error);
        alert('æ— æ³•è®¿é—®æ‘„åƒå¤´ï¼Œè¯·ç¡®ä¿å·²æˆäºˆæƒé™');
      }
    }

    function stopCamera() {
      isRunning = false;
      
      if (detectionInterval) {
        clearTimeout(detectionInterval);
        detectionInterval = null;
      }
      
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      
      document.getElementById('startBtn').disabled = false;
      document.getElementById('stopBtn').disabled = true;
      
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    async function detectFrame() {
      if (!isRunning) return;
      
      const video = document.getElementById('video');
      const canvas = document.getElementById('canvas');
      const ctx = canvas.getContext('2d');
      
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      
      const detectionCanvas = document.createElement('canvas');
      detectionCanvas.width = 640;
      detectionCanvas.height = 480;
      const detectionCtx = detectionCanvas.getContext('2d');
      detectionCtx.drawImage(video, 0, 0, 640, 480);
      
      try {
        const detections = await cocoSsd.load().then(loadedModel => {
          return loadedModel.detect(video);
        });
        
        detections.forEach(detection => {
          const [x, y, width, height] = detection.bbox;
          const className = cocoLabels[detection.class];
          const confidence = Math.round(detection.score * 100);
          
          ctx.strokeStyle = '#0088cc';
          ctx.lineWidth = 2;
          ctx.strokeRect(x, y, width, height);
          
          ctx.fillStyle = 'rgba(0, 136, 204, 0.2)';
          ctx.fillRect(x, y, width, height);
          
          ctx.fillStyle = '#0088cc';
          ctx.fillRect(x, y - 20, Math.min(ctx.measureText(className).width + 20, 120), 20);
          
          ctx.fillStyle = 'white';
          ctx.font = '12px sans-serif';
          ctx.fillText(`${className} ${confidence}%`, x + 5, y - 6);
          
          addDetection(className, confidence, 'object');
        });
        
        const faceDetections = await faceapi.detectAllFaces(video, new faceapi.TinyFaceDetectorOptions());
        
        faceDetections.forEach(async (detection) => {
          const box = detection.detection.box;
          
          ctx.strokeStyle = '#10b981';
          ctx.lineWidth = 3;
          ctx.strokeRect(box.x, box.y, box.width, box.height);
          
          const faceId = await recognizeFace(detection);
          
          if (faceId) {
            ctx.fillStyle = '#10b981';
            ctx.fillRect(box.x, box.y - 25, 100, 25);
            ctx.fillStyle = 'white';
            ctx.font = 'bold 14px sans-serif';
            ctx.fillText(faceId.name, box.x + 5, box.y - 8);
            
            addDetection(`å·²çŸ¥äººè„¸: ${faceId.name}`, faceId.confidence, 'face');
          } else {
            ctx.fillStyle = '#f59e0b';
            ctx.fillRect(box.x, box.y - 25, 80, 25);
            ctx.fillStyle = 'white';
            ctx.font = 'bold 14px sans-serif';
            ctx.fillText('æœªçŸ¥', box.x + 5, box.y - 8);
            
            addDetection('æœªçŸ¥äººè„¸', detection.score * 100, 'face');
          }
        });
        
      } catch (error) {
        console.error('æ£€æµ‹é”™è¯¯:', error);
      }
      
      detectionInterval = setTimeout(detectFrame, 500);
    }

    async function recognizeFace(faceDetection) {
      if (faceLibrary.length === 0) return null;
      
      const descriptor = await faceapi.computeFaceDescriptor(faceDetection);
      
      for (const face of faceLibrary) {
        const storedDescriptor = new Float32Array(face.descriptor);
        const distance = faceapi.euclideanDistance(descriptor, storedDescriptor);
        
        if (distance < 0.6) {
          return { name: face.name, confidence: Math.round((1 - distance) * 100) };
        }
      }
      
      return null;
    }

    function addDetection(name, confidence, type) {
      const now = new Date();
      const timeStr = now.toLocaleTimeString('zh-CN');
      
      const detection = {
        name,
        confidence,
        type,
        time: timeStr
      };
      
      recentDetections.unshift(detection);
      if (recentDetections.length > 50) {
        recentDetections.pop();
      }
      
      if (type === 'face' && name.includes('å·²çŸ¥äººè„¸')) {
        updateAlertCount(1);
      }
      
      updateDetectionList();
    }

    function updateDetectionList() {
      const objectList = document.getElementById('objectList');
      const faceList = document.getElementById('faceList');
      
      const objects = recentDetections.filter(d => d.type === 'object').slice(0, 10);
      const faces = recentDetections.filter(d => d.type === 'face').slice(0, 10);
      
      if (objects.length === 0) {
        objectList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“·</div>
            <div>æš‚æ— ç‰©ä½“æ£€æµ‹ç»“æœ</div>
          </div>
        `;
      } else {
        objectList.innerHTML = objects.map(d => {
          const icon = objectIcons[d.name.split(' ')[0]] || 'ğŸ“¦';
          const confidenceClass = d.confidence >= 80 ? 'high' : d.confidence >= 60 ? 'medium' : 'low';
          return `
            <div class="detection-item ${d.type}">
              <div class="detection-icon">${icon}</div>
              <div class="detection-info">
                <div class="detection-name">${d.name}</div>
                <div class="detection-details">æ£€æµ‹æ—¶é—´: ${d.time}</div>
                <span class="detection-confidence ${confidenceClass}">${d.confidence}%</span>
              </div>
            </div>
          `;
        }).join('');
      }
      
      if (faces.length === 0) {
        faceList.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ‘¤</div>
            <div>æš‚æ— äººè„¸æ£€æµ‹ç»“æœ</div>
          </div>
        `;
      } else {
        faceList.innerHTML = faces.map(d => {
          const confidenceClass = d.confidence >= 80 ? 'high' : d.confidence >= 60 ? 'medium' : 'low';
          const isKnown = d.name.includes('å·²çŸ¥äººè„¸');
          return `
            <div class="detection-item ${d.type}">
              <div class="detection-icon">${isKnown ? 'âœ…' : 'â“'}</div>
              <div class="detection-info">
                <div class="detection-name">${d.name}</div>
                <div class="detection-details">æ£€æµ‹æ—¶é—´: ${d.time}</div>
                <span class="detection-confidence ${confidenceClass}">${d.confidence}%</span>
              </div>
            </div>
          `;
        }).join('');
      }
    }

    async function captureFace(name) {
      const video = document.getElementById('video');
      
      const tempCanvas = document.createElement('canvas');
      tempCanvas.width = 160;
      tempCanvas.height = 160;
      const ctx = tempCanvas.getContext('2d');
      ctx.drawImage(video, 280, 140, 80, 80, 0, 0, 160, 160);
      
      const faceImage = tempCanvas.toDataURL('image/jpeg', 0.8);
      
      const detection = await faceapi.detectSingleFace(video);
      if (!detection) {
        alert('æœªæ£€æµ‹åˆ°äººè„¸ï¼Œè¯·ç¡®ä¿è„¸éƒ¨åœ¨ç”»é¢ä¸­å¤®');
        return;
      }
      
      const descriptor = await faceapi.computeFaceDescriptor(detection);
      
      const newFace = {
        id: Date.now(),
        name: name || `äººè„¸${faceLibrary.length + 1}`,
        image: faceImage,
        descriptor: Array.from(descriptor),
        createdAt: new Date().toISOString()
      };
      
      faceLibrary.push(newFace);
      localStorage.setItem('faceLibrary', JSON.stringify(faceLibrary));
      
      renderFaceLibrary();
      alert(`å·²æ·»åŠ äººè„¸: ${newFace.name}`);
    }

    function renderFaceLibrary() {
      const container = document.getElementById('faceLibrary');
      
      if (faceLibrary.length === 0) {
        container.innerHTML = `
          <div class="empty-state" style="grid-column: 1 / -1; padding: 20px;">
            <div class="empty-state-icon">ğŸ‘¥</div>
            <div style="margin-bottom: 12px;">äººè„¸åº“ä¸ºç©º</div>
            <button class="btn btn-primary" onclick="promptAddFace()">æ·»åŠ äººè„¸</button>
          </div>
        `;
      } else {
        container.innerHTML = faceLibrary.map(face => `
          <div class="face-card">
            <div class="face-image">
              <img src="${face.image}" alt="${face.name}">
            </div>
            <div class="face-name">${face.name}</div>
          </div>
        `).join('');
      }
    }

    function promptAddFace() {
      const name = prompt('è¯·è¾“å…¥äººè„¸åç§°ï¼ˆå¦‚ï¼šå¼ ä¸‰ï¼‰:');
      if (name && name.trim()) {
        captureFace(name.trim());
      }
    }

    function deleteFace(id) {
      if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªäººè„¸å—ï¼Ÿ')) {
        faceLibrary = faceLibrary.filter(f => f.id !== id);
        localStorage.setItem('faceLibrary', JSON.stringify(faceLibrary));
        renderFaceLibrary();
      }
    }

    function clearFaceLibrary() {
      if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰äººè„¸å—ï¼Ÿ')) {
        faceLibrary = [];
        localStorage.setItem('faceLibrary', '[]');
        renderFaceLibrary();
      }
    }

    function switchTab(tab) {
      currentTab = tab;
      
      document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.panel-tab[data-tab="${tab}"]`).classList.add('active');
      
      document.getElementById('objectsTab').style.display = tab === 'objects' ? 'block' : 'none';
      document.getElementById('facesTab').style.display = tab === 'faces' ? 'block' : 'none';
    }

    function updateAlertCount(count) {
      const badge = document.getElementById('alertCount');
      const current = parseInt(badge.textContent);
      badge.textContent = current + count;
    }

    loadModels();
  </script>
</body>
</html>
